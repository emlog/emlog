<?php defined('EMLOG_ROOT')or die('access denied!');function em_static_template($ç¾){$ç¾=preg_replace('/[^A-Z_a-z]/','',$ç¾);$€ç¼ =EM_STATIC_ROOT."/templates/{$ç¾}.php";return $€ç¼ ;}function em_static_write_file($€ç¼ ,$äº•){$‚æ»‘=fopen($€ç¼ ,'w+');fwrite($‚æ»‘,$äº•);fclose($‚æ»‘);}function em_static_tag_to_url($ƒæ¸){$„ç½ƒ=EMStatic_Pinyin::get_instance();$ƒæ¸=$„ç½ƒ->cover($ƒæ¸);$ƒæ¸=str_replace(' ','',$ƒæ¸);$ƒæ¸=strtolower($ƒæ¸);$ƒæ¸=preg_replace('/[^\w-_]/','',$ƒæ¸);return $ƒæ¸;}function em_static_update_post($…èº•){em_static_create_cron_job_by_post_id($…èº•);}function em_static_delete_post($…èº•){em_static_create_cron_job_by_post_id($…èº•);}function em_static_update_comment(){if($GLOBALS['em_static_config_data']['enable_auto_create']==0)return;$†å½=isset($_POST['comname'])?addslashes(trim($_POST['comname'])):'';$äº•=isset($_POST['comment'])?addslashes(trim($_POST['comment'])):'';$‡é¼‰=isset($_POST['commail'])?addslashes(trim($_POST['commail'])):'';$ˆé¹†=isset($_POST['comurl'])?addslashes(trim($_POST['comurl'])):'';$‰è¾”=isset($_POST['imgcode'])?strtoupper(trim($_POST['imgcode'])):'';$Šé¾–=isset($_POST['gid'])?intval($_POST['gid']):-1;$‹è¼†=isset($_POST['pid'])?intval($_POST['pid']):0;if(!$Šé¾–){return;}$Œç½•=new Comment_Model();$æ¼„=1;if($Œç½•->isLogCanComment($Šé¾–)===false){$æ¼„=0;}elseif($Œç½•->isCommentExist($Šé¾–,$†å½,$äº•)===true){$æ¼„=0;}elseif(empty($†å½)){$æ¼„=0;}elseif(strlen($†å½)>20){$æ¼„=0;}elseif($‡é¼‰!=''&&!checkMail($‡é¼‰)){$æ¼„=0;}elseif(ISLOGIN==false&&$Œç½•->isNameAndMailValid($†å½,$‡é¼‰)===false){$æ¼„=0;}elseif(!empty($ˆé¹†)&&preg_match("/^(http|https)\:\/\/[^<>'\"]*$/",$ˆé¹†)==false){$æ¼„=0;}elseif(empty($äº•)){$æ¼„=0;}elseif(strlen($äº•)>8000){$æ¼„=0;}if($æ¼„==1){$ç½ˆ=Mysql::getInstance();$ä»='SELECT alias FROM '.DB_PREFIX.'blog WHERE gid = '.$Šé¾–;$æ¸Œ=$ç½ˆ->once_fetch_array($ä»);em_static_add_cron_job('post',$Šé¾–.','.$æ¸Œ['alias'],1);}}function em_static_create_cron_job_by_post_id($…èº•){$ç½ˆ=Mysql::getInstance();$‘æ¼†=Cache::getInstance()->readCache('logtags');$’å½œ=array();if(is_file(EM_STATIC_TAG_CACHE_FILE)){$’å½œ=include EM_STATIC_TAG_CACHE_FILE;}$„ç½ƒ=EMStatic_Pinyin::get_instance();$“ä¸š='<?php defined(\'EMLOG_ROOT\') or die(\'æœ¬é¡µé¢ç¦æ­¢ç›´æ¥è®¿é—®!\');'.chr(10);$“ä¸š.='return array('.chr(10);$”ç¾š=$ç½ˆ->query('SELECT * FROM '.DB_PREFIX.'tag');while($•å¼Š=$ç½ˆ->fetch_array($”ç¾š)){if(!isset($’å½œ[$•å¼Š['tid']])){$–å¼–=$„ç½ƒ->cover($•å¼Š['tagname']);$–å¼–=preg_replace('/[^\w-_]+/','',$–å¼–);$’å½œ[$•å¼Š['tid']]=$–å¼–;$’å½œ[$•å¼Š['tagname']]=$–å¼–;}}foreach($’å½œ as $—å¼“=>$˜ç¹š){if(is_int($—å¼“)){$“ä¸š.='	'.$—å¼“.' => "'.$˜ç¹š.'", '.chr(10);}else{$“ä¸š.='	"'.$—å¼“.'" => "'.$˜ç¹š.'", '.chr(10);}}$“ä¸š.=');';file_put_contents(EM_STATIC_TAG_CACHE_FILE,$“ä¸š);if($GLOBALS['em_static_config_data']['enable_auto_create']==0)return;$™ç½’=Option::get('index_lognum');$ä»='SELECT sortid, author, date, alias, hide FROM '.DB_PREFIX.'blog WHERE gid = '.$…èº•;$æ¸Œ=$ç½ˆ->once_fetch_array($ä»);if($æ¸Œ['hide']=='y')return;em_static_add_cron_job('index','','',1);em_static_add_cron_job('post',$…èº•.','.$æ¸Œ['alias'],1);$šè»Œ=$ç½ˆ->once_fetch_array("SELECT COUNT(*) AS total FROM ".DB_PREFIX."blog WHERE type = 'blog'");$›èº’=@ceil($šè»Œ['total']/$™ç½’);for($œè½š=1;$œè½š<=$›èº’;$œè½š++){if($œè½š==1){em_static_add_cron_job('page','',$œè½š,1);}else{em_static_add_cron_job('page','',$œè½š);}}$šè»Œ=$ç½ˆ->once_fetch_array("SELECT COUNT(*) AS total FROM ".DB_PREFIX."blog WHERE type = 'blog' AND author = ".$æ¸Œ['author']);$›èº’=@ceil($šè»Œ['total']/$™ç½’);for($œè½š=1;$œè½š<=$›èº’;$œè½š++){if($œè½š==1){em_static_add_cron_job('author',$æ¸Œ['author'],$œè½š,1);}else{em_static_add_cron_job('author',$æ¸Œ['author'],$œè½š);}}if(isset($æ¸Œ['sortid'])&&$æ¸Œ['sortid']!='-1'){$šè»Œ=$ç½ˆ->once_fetch_array("SELECT COUNT(*) AS total FROM ".DB_PREFIX."blog WHERE type = 'blog' AND sortid = ".$æ¸Œ['sortid']);$›èº’=@ceil($šè»Œ['total']/$™ç½’);$è½=$ç½ˆ->once_fetch_array("SELECT alias FROM ".DB_PREFIX."sort WHERE sid = ".$æ¸Œ['sortid']);$–å¼–=$è½?$è½['alias']:'';for($œè½š=1;$œè½š<=$›èº’;$œè½š++){if($œè½š==1){em_static_add_cron_job('sort',$æ¸Œ['sortid'].','.$–å¼–,$œè½š,1);}else{em_static_add_cron_job('sort',$æ¸Œ['sortid'].','.$–å¼–,$œè½š);}}}if(isset($‘æ¼†[$…èº•])&&!empty($‘æ¼†[$…èº•])){$è¹‚=$‘æ¼†[$…èº•];foreach($è¹‚ as $ƒæ¸){$•å¼Š=$ç½ˆ->once_fetch_array("SELECT tid, tagname, gid FROM ".DB_PREFIX."tag WHERE tagname = '{$ƒæ¸['tagname']}'");$Ÿè»€=substr(trim($•å¼Š['gid']),1,-1);if($•å¼Š){$šè»Œ=$ç½ˆ->once_fetch_array("SELECT COUNT(*) AS total FROM ".DB_PREFIX."blog WHERE type = 'blog' AND gid IN ($Ÿè»€)");$›èº’=@ceil($šè»Œ['total']/$™ç½’);for($œè½š=1;$œè½š<=$›èº’;$œè½š++){em_static_add_cron_job('tag',$•å¼Š['tid'].','.$•å¼Š['tagname'].','.$’å½œ[$•å¼Š['tid']],$œè½š);}}}}$ ç¹˜=gmdate('Ym',$æ¸Œ['date']);if(preg_match("/^([\d]{4})([\d]{2})$/",$ ç¹˜,$¡æ¼)){$¢ç¹=getMonthDayNum($¡æ¼[2],$¡æ¼[1]);$£è¾˜=emStrtotime($ ç¹˜.'01');$¤å»Ÿ=$£è¾˜+3600*24*$¢ç¹;}else{$£è¾˜=emStrtotime($ ç¹˜);$¤å»Ÿ=$£è¾˜+3600*24;}$ä»="SELECT COUNT(*) AS total FROM ".DB_PREFIX."blog WHERE type = 'blog' AND date >= $£è¾˜ AND date < $¤å»Ÿ ORDER BY top DESC, date DESC";$šè»Œ=$ç½ˆ->once_fetch_array($ä»);$›èº’=@ceil($šè»Œ['total']/$™ç½’);for($œè½š=1;$œè½š<=$›èº’;$œè½š++){em_static_add_cron_job('record',$ ç¹˜,$œè½š);}}function em_static_print_cront_js(){$ˆé¹†=BLOG_URL.'content/plugins/em_static/em_static_cron.php';echo"
		<script>
		(function() {
		     var s = document.createElement('script');
		     s.type = 'text/javascript';
		     s.async = true;
		     s.src = '$ˆé¹†?t='+ new Date().getTime();
		     var x = document.getElementsByTagName('script')[0];
		     x.parentNode.insertBefore(s, x);
		 })();
		 </script>		
	";}function em_static_add_cron_job($¥é¹›,$¦å¸”='',$œè½š=0,$§é¹ =0){$ä»="INSERT INTO ".DB_PREFIX."emstatic_cronjob (`id`, `piror`, `locked`, `type`, `data`, `page`) VALUES (NULL, %d, 0, '%s', '%s', %d)";$ä»=sprintf($ä»,$§é¹ ,$¥é¹›,$¦å¸”,$œè½š);$ç½ˆ=Mysql::getInstance();$ç½ˆ->query($ä»);}class EMStatic{protected static $¨ç¹Œ;protected $©ä»œ;protected $ªä¸‰;protected $«ç¸‘;protected function __construct(){$this->_config=include EM_STATIC_ROOT.'/em_static_config.php';if(is_file(EM_STATIC_TAG_CACHE_FILE))$this->_tagcache=include EM_STATIC_TAG_CACHE_FILE;}public static function get_instance(){if(!self::$¨ç¹Œ){self::$¨ç¹Œ=new EMStatic();}return self::$¨ç¹Œ;}public function get_config(){return $this->_config;}public function create_index_page(){$äº•=$this->fetch_page('');$äº•=$this->page_link_replace($äº•);em_static_write_file(EMLOG_ROOT.'/index.html',$äº•);}public function create_post_pages($¬ç¹,$­ä¸•){$this->_create_path_folders($this->_config['page_path']);$ç½ˆ=Mysql::getInstance();$ä»='SELECT gid, alias FROM '.DB_PREFIX.'blog WHERE hide = \'n\' LIMIT '.$¬ç¹.','.$­ä¸•;$”ç¾š=$ç½ˆ->query($ä»);if($ç½ˆ->num_rows($”ç¾š)>0){while($®ä¹“=$ç½ˆ->fetch_array($”ç¾š)){$this->create_post_page($®ä¹“['gid'],$®ä¹“['alias']);}return true;}return false;}public function create_post_page($¯è¾—,$–å¼–=''){$ˆé¹†='?post='.$¯è¾—;$äº•=$this->fetch_page($ˆé¹†);$äº•=$this->page_link_replace($äº•);if(empty($–å¼–))$€ç¼ =$this->_get_post_path_with_id($¯è¾—);else $€ç¼ =$this->_get_post_path_with_alias($–å¼–);em_static_write_file(EMLOG_ROOT.'/'.$€ç¼ ,$äº•);$°éº=new Comment_Model();$±éºˆ=$°éº->getCommentNum($¯è¾—);$²æ¼†=Cache::getInstance()->readCache('options');$›èº’=@ceil($±éºˆ/$²æ¼†['comment_pnum']);if($›èº’>1){for($³å¾ˆ=2;$³å¾ˆ<=$›èº’;$³å¾ˆ++){if(empty($–å¼–))$€ç¼ =$this->_get_post_comment_page_path_with_id($¯è¾—,$³å¾ˆ);else $€ç¼ =$this->_get_post_comment_page_path_with_alias($–å¼–,$³å¾ˆ);$ˆé¹†='?post='.$¯è¾—.'&comment-page='.$³å¾ˆ;$äº•=$this->fetch_page($ˆé¹†);$äº•=$this->page_link_replace($äº•);em_static_write_file(EMLOG_ROOT.'/'.$€ç¼ ,$äº•);}}}public function create_sort_pages($´èº“,$–å¼–,$¬ç¹,$­ä¸•){$ç½ˆ=Mysql::getInstance();$ä»='SELECT COUNT(*) AS total FROM '.DB_PREFIX.'blog WHERE sortid = '.$´èº“;$”ç¾š=$ç½ˆ->once_fetch_array($ä»);$²æ¼†=Cache::getInstance()->readCache('options');$›èº’=@ceil($”ç¾š['total']/$²æ¼†['index_lognum']);if($›èº’==1||$¬ç¹==2){$this->create_sort_index_page($´èº“,$–å¼–);}if($›èº’>1){if($›èº’<$¬ç¹)return false;$µç¾†=$¬ç¹+$­ä¸•;if($µç¾†>$›èº’)$µç¾†=$›èº’;for($³å¾ˆ=$¬ç¹;$³å¾ˆ<=$µç¾†;$³å¾ˆ++){$this->create_sort_page($´èº“,$–å¼–,$³å¾ˆ);}return true;}return false;}public function create_sort_index_page($´èº“,$–å¼–=''){if(empty($–å¼–)){$€ç¼ =$this->_get_sort_path_with_id($´èº“);}else{$€ç¼ =$this->_get_sort_path_with_alias($–å¼–);}$ˆé¹†='?sort='.$´èº“;$äº•=$this->fetch_page($ˆé¹†);$äº•=$this->page_link_replace($äº•);em_static_write_file(EMLOG_ROOT.'/'.$€ç¼ ,$äº•);}public function create_sort_page($´èº“,$–å¼–='',$œè½š=0){if(empty($–å¼–)){$€ç¼ =$this->_get_sort_page_path_with_id($´èº“,$œè½š);}else{$€ç¼ =$this->_get_sort_page_path_with_alias($–å¼–,$œè½š);}$ˆé¹†='?sort='.$´èº“.'&page='.$œè½š;$äº•=$this->fetch_page($ˆé¹†);$äº•=$this->page_link_replace($äº•);em_static_write_file(EMLOG_ROOT.'/'.$€ç¼ ,$äº•);}public function create_static_pages(){$ç½ˆ=Mysql::getInstance();$ä»='SELECT gid,alias FROM '.DB_PREFIX.'blog WHERE type=\'page\'';$”ç¾š=$ç½ˆ->query($ä»);while($¶å¸ˆ=$ç½ˆ->fetch_array($”ç¾š)){$this->create_post_page($¶å¸ˆ['gid'],empty($¶å¸ˆ['alias'])?'':$¶å¸ˆ['alias']);}}public function create_pagination_pages($¬ç¹,$­ä¸•){$²æ¼†=Cache::getInstance()->readCache('options');$·é¹=new Log_Model();$¸è¾Ÿ=$·é¹->getLogNum();$›èº’=@ceil($¸è¾Ÿ/$²æ¼†['index_lognum']);if($›èº’>1){if($›èº’<$¬ç¹)return false;$µç¾†=$¬ç¹+$­ä¸•;if($µç¾†>$›èº’)$µç¾†=$›èº’;for($³å¾ˆ=$¬ç¹;$³å¾ˆ<=$µç¾†;$³å¾ˆ++){$this->create_pagination_page($³å¾ˆ);}return true;}return false;}public function create_pagination_page($¹ä½){$€ç¼ =$this->_get_page_path($¹ä½);$ˆé¹†='?page='.$¹ä½;$äº•=$this->fetch_page($ˆé¹†);$äº•=$this->page_link_replace($äº•);em_static_write_file(EMLOG_ROOT.'/'.$€ç¼ ,$äº•);}public function create_tag_pages($ºé¾,$»å¼ƒ,$¼ä¸’,$¬ç¹,$­ä¸•){$²æ¼†=Cache::getInstance()->readCache('options');$·é¹=new Log_Model();$¼ä¸’=substr(trim($¼ä¸’),1,-1);$½ç¼–="and gid IN ({$¼ä¸’}) order by date desc";$¾å½›=$·é¹->getLogNum('n',$½ç¼–);$›èº’=@ceil($¾å½›/$²æ¼†['index_lognum']);if($›èº’==1||$¬ç¹==2){$this->create_tag_index_page($ºé¾,$»å¼ƒ);}if($›èº’>1){if($›èº’<$¬ç¹)return false;$µç¾†=$¬ç¹+$­ä¸•;if($µç¾†>$›èº’)$µç¾†=$›èº’;for($³å¾ˆ=$¬ç¹;$³å¾ˆ<=$µç¾†;$³å¾ˆ++){$this->create_tag_page($ºé¾,$»å¼ƒ,$³å¾ˆ);}return true;}return false;}public function create_tag_index_page($ºé¾,$»å¼ƒ){$ˆé¹†='?tag='.rawurlencode($ºé¾);$äº•=$this->fetch_page($ˆé¹†);$€ç¼ =EMLOG_ROOT.'/'.$this->_get_tag_path($»å¼ƒ);$äº•=$this->page_link_replace($äº•);em_static_write_file($€ç¼ ,$äº•);}public function create_tag_page($ºé¾,$»å¼ƒ,$œè½š=0){$ˆé¹†='?tag='.rawurlencode($ºé¾).'&page='.$œè½š;$€ç¼ =EMLOG_ROOT.'/'.$this->_get_tag_page_path($»å¼ƒ,$œè½š);$äº•=$this->fetch_page($ˆé¹†);$äº•=$this->page_link_replace($äº•);em_static_write_file($€ç¼ ,$äº•);}public function create_author_pages($¿å¾,$¬ç¹,$­ä¸•){$Àæ¹‹=Cache::getInstance();$²æ¼†=$Àæ¹‹->readCache('options');$Áé½›=$Àæ¹‹->readCache('sta');$¸è¾Ÿ=$Áé½›[$¿å¾]['lognum'];$›èº’=@ceil($¸è¾Ÿ/$²æ¼†['index_lognum']);if($›èº’==1||$¬ç¹==2){$this->create_author_index_page($¿å¾);}if($›èº’>1){if($›èº’<$¬ç¹)return false;$µç¾†=$¬ç¹+$­ä¸•;if($µç¾†>$›èº’)$µç¾†=$›èº’;for($³å¾ˆ=$¬ç¹;$³å¾ˆ<=$µç¾†;$³å¾ˆ++){$this->create_author_page($¿å¾,$³å¾ˆ);}return true;}return false;}public function create_author_index_page($Âè¹…){$ˆé¹†='?author='.$Âè¹…;$äº•=$this->fetch_page($ˆé¹†);$€ç¼ =EMLOG_ROOT.'/'.$this->_get_author_path($Âè¹…);$äº•=$this->page_link_replace($äº•);em_static_write_file($€ç¼ ,$äº•);}public function create_author_page($Âè¹…,$œè½š){$ˆé¹†='?author='.$Âè¹….'&page='.$œè½š;$€ç¼ =EMLOG_ROOT.'/'.$this->_get_author_page_path($Âè¹…,$œè½š);$äº•=$this->fetch_page($ˆé¹†);$äº•=$this->page_link_replace($äº•);em_static_write_file($€ç¼ ,$äº•);}public function create_record_pages($Ãç½Œ,$Äé»–,$¬ç¹,$­ä¸•){$Àæ¹‹=Cache::getInstance();$²æ¼†=$Àæ¹‹->readCache('options');$›èº’=@ceil($Äé»–/$²æ¼†['index_lognum']);if($›èº’==1OR $¬ç¹==2){$this->create_record_index_page($Ãç½Œ);}if($›èº’>1){if($›èº’<$¬ç¹)return false;$µç¾†=$¬ç¹+$­ä¸•;if($µç¾†>$›èº’)$µç¾†=$›èº’;for($³å¾ˆ=$¬ç¹;$³å¾ˆ<=$µç¾†;$³å¾ˆ++){$this->create_record_page($Ãç½Œ,$³å¾ˆ);}return true;}return false;}public function create_record_index_page($Ãç½Œ){$ˆé¹†='?record='.$Ãç½Œ;$äº•=$this->fetch_page($ˆé¹†);$€ç¼ =EMLOG_ROOT.'/'.$this->_get_record_path($Ãç½Œ);$äº•=$this->page_link_replace($äº•);em_static_write_file($€ç¼ ,$äº•);}public function create_record_page($Ãç½Œ,$œè½š){$ˆé¹†='?record='.$Ãç½Œ.'&page='.$œè½š;$€ç¼ =EMLOG_ROOT.'/'.$this->_get_record_page_path($Ãç½Œ,$œè½š);$äº•=$this->fetch_page($ˆé¹†);$äº•=$this->page_link_replace($äº•);em_static_write_file($€ç¼ ,$äº•);}public function page_link_replace($äº•){$Åæ½=str_replace('/','\\/',BLOG_URL);$äº•=preg_replace_callback('/('.$Åæ½.')\?post=(\d+)&comment-page=(\d+)/',array($this,'page_comment_page_url_replace_callback'),$äº•);$äº•=preg_replace_callback('/('.$Åæ½.')\?post=(\d+)/',array($this,'post_url_replace_callback'),$äº•);$äº•=preg_replace_callback('/('.$Åæ½.')\?page=(\d+)/',array($this,'page_url_replace_callback'),$äº•);$äº•=preg_replace_callback('/('.$Åæ½.')\?sort=(\d+)&page=(\d+)/',array($this,'sort_page_url_replace_callback'),$äº•);$äº•=preg_replace_callback('/('.$Åæ½.')\?sort=(\d+)/',array($this,'sort_url_replace_callback'),$äº•);$äº•=preg_replace_callback('/('.$Åæ½.')\?tag=([\w%\\+-]+)&page=(\d+)/',array($this,'tag_page_url_replace_callback'),$äº•);$äº•=preg_replace_callback('/('.$Åæ½.')\?tag=([\w%\\+-]+)/',array($this,'tag_url_replace_callback'),$äº•);$äº•=preg_replace_callback('/('.$Åæ½.')\?record=(\d+)&page=(\d+)/',array($this,'record_page_url_replace_callback'),$äº•);$äº•=preg_replace_callback('/('.$Åæ½.')\?record=(\d+)/',array($this,'record_url_replace_callback'),$äº•);$äº•=preg_replace_callback('/('.$Åæ½.')\?author=(\d+)&page=(\d+)/',array($this,'author_page_url_replace_callback'),$äº•);$äº•=preg_replace_callback('/('.$Åæ½.')\?author=(\d+)/',array($this,'author_url_replace_callback'),$äº•);$äº•=preg_replace('/('.$Åæ½.')\?(.+)/','$1index.php?$2',$äº•);return $äº•;}public function post_url_replace_callback($Æå¼“){$Çå»=Cache::getInstance()->readCache('logalias');if(!empty($Çå»[$Æå¼“[2]])){$ˆé¹†=$Æå¼“[1].$this->_get_post_path_with_alias($Çå»[$Æå¼“[2]]);return $ˆé¹†;}else{$ˆé¹†=$Æå¼“[1].$this->_get_post_path_with_id($Æå¼“[2]);return $ˆé¹†;}}protected function _get_post_path_with_id($…èº•){$€ç¼ =str_replace('{%æ—¥å¿—id%}',$…èº•,$this->_config['post_format']);$Èä»=str_replace('{%æ—¥å¿—id%}',$…èº•,$this->_config['post_path']);$this->_create_path_folders($Èä»);return $Èä».$€ç¼ ;}protected function _get_post_path_with_alias($–å¼–){$€ç¼ =str_replace('{%æ—¥å¿—åˆ«å%}',$–å¼–,$this->_config['post_alias_format']);$Èä»=str_replace('{%æ—¥å¿—åˆ«å%}',$–å¼–,$this->_config['post_alias_path']);$this->_create_path_folders($Èä»);return $Èä».$€ç¼ ;}public function page_comment_page_url_replace_callback($Æå¼“){$Çå»=Cache::getInstance()->readCache('logalias');if(!empty($Çå»[$Æå¼“[2]])){$ˆé¹†=$Æå¼“[1].$this->_get_post_comment_page_path_with_alias($Çå»[$Æå¼“[2]],$Æå¼“[3]);return $ˆé¹†;}else{$ˆé¹†=$Æå¼“[1].$this->_get_post_comment_page_path_with_id($Æå¼“[2],$Æå¼“[3]);return $ˆé¹†;}}protected function _get_post_comment_page_path($…èº•,$œè½š){$€ç¼ =str_replace('{%æ—¥å¿—id%}',$…èº•,$this->_config['post_comment_page_format']);$€ç¼ =str_replace('{%é¡µç %}',$œè½š,$€ç¼ );$Èä»=str_replace('{%æ—¥å¿—id%}',$…èº•,$this->_config['post_comment_page_path']);$this->_create_path_folders($Èä»);return $Èä».$€ç¼ ;}public function page_url_replace_callback($Æå¼“){$ˆé¹†=$Æå¼“[1].$this->_get_page_path($Æå¼“[2]);return $ˆé¹†;}protected function _get_page_path($œè½š){$€ç¼ =str_replace('{%é¡µç %}',$œè½š,$this->_config['page_format']);$this->_create_path_folders($this->_config['page_path']);return $this->_config['page_path'].$€ç¼ ;}public function sort_url_replace_callback($Æå¼“){$Éè½=Cache::getInstance();$Êä½˜=$Éè½->readCache('sort');if(isset($Êä½˜[$Æå¼“[2]]['alias'])&&!empty($Êä½˜[$Æå¼“[2]]['alias'])){return $Æå¼“[1].$this->_get_sort_path_with_alias($Êä½˜[$Æå¼“[2]]['alias']);}else{return $Æå¼“[1].$this->_get_sort_path_with_id($Æå¼“[2]);}}protected function _get_sort_path_with_id($´èº“){$€ç¼ =str_replace('{%åˆ†ç±»id%}',$´èº“,$this->_config['sort_format']);$Èä»=str_replace('{%åˆ†ç±»id%}',$´èº“,$this->_config['sort_path']);$this->_create_path_folders($Èä»);return $Èä».$€ç¼ ;}protected function _get_sort_path_with_alias($–å¼–){$€ç¼ =str_replace('{%åˆ†ç±»åˆ«å%}',$–å¼–,$this->_config['sort_alias_format']);$Èä»=str_replace('{%åˆ†ç±»åˆ«å%}',$–å¼–,$this->_config['sort_alias_path']);$this->_create_path_folders($Èä»);return $Èä».$€ç¼ ;}protected function _get_post_comment_page_path_with_id($…èº•,$œè½š){$€ç¼ =str_replace('{%æ—¥å¿—id%}',$…èº•,$this->_config['post_comment_page_format']);$€ç¼ =str_replace('{%é¡µç %}',$œè½š,$€ç¼ );$Èä»=str_replace('{%æ—¥å¿—id%}',$…èº•,$this->_config['post_comment_page_path']);$this->_create_path_folders($Èä»);return $Èä».$€ç¼ ;}protected function _get_post_comment_page_path_with_alias($–å¼–,$œè½š){$€ç¼ =str_replace('{%æ—¥å¿—åˆ«å%}',$–å¼–,$this->_config['post_comment_alias_page_format']);$€ç¼ =str_replace('{%é¡µç %}',$œè½š,$€ç¼ );$Èä»=str_replace('{%æ—¥å¿—åˆ«å%}',$–å¼–,$this->_config['post_comment_alias_page_path']);$this->_create_path_folders($Èä»);return $Èä».$€ç¼ ;}public function sort_page_url_replace_callback($Æå¼“){$Éè½=Cache::getInstance();$Êä½˜=$Éè½->readCache('sort');if(isset($Êä½˜[$Æå¼“[2]]['alias'])&&!empty($Êä½˜[$Æå¼“[2]]['alias'])){return $Æå¼“[1].$this->_get_sort_page_path_with_alias($Êä½˜[$Æå¼“[2]]['alias'],$Æå¼“[3]);}else{return $Æå¼“[1].$this->_get_sort_page_path_with_id($Æå¼“[2],$Æå¼“[3]);}}protected function _get_sort_page_path_with_id($´èº“,$œè½š){$€ç¼ =str_replace('{%åˆ†ç±»id%}',$´èº“,$this->_config['sort_page_format']);$€ç¼ =str_replace('{%é¡µç %}',$œè½š,$€ç¼ );$Èä»=str_replace('{%åˆ†ç±»id%}',$´èº“,$this->_config['sort_page_path']);$this->_create_path_folders($Èä»);return $Èä».$€ç¼ ;}protected function _get_sort_page_path_with_alias($–å¼–,$œè½š){$€ç¼ =str_replace('{%åˆ†ç±»åˆ«å%}',$–å¼–,$this->_config['sort_page_alias_format']);$€ç¼ =str_replace('{%é¡µç %}',$œè½š,$€ç¼ );$Èä»=str_replace('{%åˆ†ç±»åˆ«å%}',$–å¼–,$this->_config['sort_page_alias_path']);$this->_create_path_folders($Èä»);return $Èä».$€ç¼ ;}public function tag_url_replace_callback($Æå¼“){$ƒæ¸=$Æå¼“[2];$ƒæ¸=str_replace('+',' ',rawurldecode($ƒæ¸));return $Æå¼“[1].$this->_get_tag_path($ƒæ¸);}protected function _get_tag_path($ƒæ¸){if(isset($this->_tagcache[$ƒæ¸]))$ƒæ¸=$this->_tagcache[$ƒæ¸];else $ƒæ¸=urlencode($ƒæ¸);$€ç¼ =str_replace('{%æ ‡ç­¾åˆ«å%}',$ƒæ¸,$this->_config['tag_format']);$Èä»=str_replace('{%æ ‡ç­¾åˆ«å%}',$ƒæ¸,$this->_config['tag_path']);$this->_create_path_folders($Èä»);return $Èä».$€ç¼ ;}public function tag_page_url_replace_callback($Æå¼“){$ƒæ¸=$Æå¼“[2];$ƒæ¸=str_replace('+',' ',rawurldecode($ƒæ¸));return $Æå¼“[1].$this->_get_tag_page_path($ƒæ¸,$Æå¼“[3]);}protected function _get_tag_page_path($ƒæ¸,$œè½š){if(isset($this->_tagcache[$ƒæ¸]))$ƒæ¸=$this->_tagcache[$ƒæ¸];else $ƒæ¸=urlencode($ƒæ¸);$€ç¼ =str_replace('{%æ ‡ç­¾åˆ«å%}',$ƒæ¸,$this->_config['tag_page_format']);$€ç¼ =str_replace('{%é¡µç %}',$œè½š,$€ç¼ );$Èä»=str_replace('{%æ ‡ç­¾åˆ«å%}',$ƒæ¸,$this->_config['tag_page_path']);$this->_create_path_folders($Èä»);return $Èä».$€ç¼ ;}public function record_url_replace_callback($Æå¼“){return $Æå¼“[1].$this->_get_record_path($Æå¼“[2]);}protected function _get_record_path($Ëçºˆ){$€ç¼ =str_replace('{%æ—¥æœŸ%}',$Ëçºˆ,$this->_config['record_format']);$Èä»=str_replace('{%æ—¥æœŸ%}',$Ëçºˆ,$this->_config['record_path']);$this->_create_path_folders($Èä»);return $Èä».$€ç¼ ;}public function record_page_url_replace_callback($Æå¼“){return $Æå¼“[1].$this->_get_record_page_path($Æå¼“[2],$Æå¼“[3]);}protected function _get_record_page_path($Ëçºˆ,$œè½š){$€ç¼ =str_replace('{%æ—¥æœŸ%}',$Ëçºˆ,$this->_config['record_page_format']);$€ç¼ =str_replace('{%é¡µç %}',$œè½š,$€ç¼ );$Èä»=str_replace('{%æ—¥æœŸ%}',$Ëçºˆ,$this->_config['record_page_path']);$this->_create_path_folders($Èä»);return $Èä».$€ç¼ ;}public function author_url_replace_callback($Æå¼“){return $Æå¼“[1].$this->_get_author_path($Æå¼“[2]);}protected function _get_author_path($Âè¹…){$€ç¼ =str_replace('{%ç”¨æˆ·id%}',$Âè¹…,$this->_config['author_format']);$Èä»=str_replace('{%ç”¨æˆ·id%}',$Âè¹…,$this->_config['author_path']);$this->_create_path_folders($Èä»);return $Èä».$€ç¼ ;}public function author_page_url_replace_callback($Æå¼“){return $Æå¼“[1].$this->_get_author_page_path($Æå¼“[2],$Æå¼“[3]);}protected function _get_author_page_path($Âè¹…,$œè½š){$€ç¼ =str_replace('{%ç”¨æˆ·id%}',$Âè¹…,$this->_config['author_page_format']);$€ç¼ =str_replace('{%é¡µç %}',$œè½š,$€ç¼ );$Èä»=str_replace('{%ç”¨æˆ·id%}',$Âè¹…,$this->_config['author_page_path']);$this->_create_path_folders($Èä»);return $Èä».$€ç¼ ;}protected function fetch_page($ˆé¹†){$ˆé¹†=BLOG_URL.'index.php'.$ˆé¹†;$Ìå¹„=EmStatic_Http::factory($ˆé¹†);$äº•=$Ìå¹„->send();return $äº•;}protected function _create_path_folders($Èä»){if(empty($Èä»))return;if(is_dir(EMLOG_ROOT.'/'.$Èä»))return;$Íå»’=explode('/',$Èä»);$Îæ¾š=EMLOG_ROOT;foreach($Íå»’ as $Ïéº‹){$Îæ¾š.='/'.$Ïéº‹;if(!is_dir($Îæ¾š)){@mkdir($Îæ¾š);}}}protected function _debug($Ğä¸“){$‚æ»‘=fopen('./debug.txt','a');fwrite($‚æ»‘,var_export($Ğä¸“.chr(10),true));fclose($‚æ»‘);}}class EmStatic_Http{const TYPE_CURL=1;const TYPE_SOCK=2;const TYPE_STREAM=3;protected static $¨ç¹Œ=null;protected function __clone(){}protected function __construct(){}public static function factory($ˆé¹†='',$¥é¹›=self::TYPE_CURL){if(self::$¨ç¹Œ instanceof Http_Basic){return self::$¨ç¹Œ;}if($¥é¹›==''){$¥é¹›=self::TYPE_SOCK;}switch($¥é¹›){case  self::TYPE_CURL:if(!function_exists('curl_init')){throw new Exception(__CLASS__." PHP CURL extension not install");}self::$¨ç¹Œ=new EmStatic_Http_Curl($ˆé¹†);break;case  self::TYPE_SOCK:if(!function_exists('fsockopen')){throw new Exception(__CLASS__." PHP function fsockopen() not support");}self::$¨ç¹Œ=new EmStatic_Http_Sock($ˆé¹†);break;case  self::TYPE_STREAM:if(!function_exists('stream_context_create')){throw new Exception(__CLASS__." PHP Stream extension not install");}self::$¨ç¹Œ=new EmStatic_Http_Stream($ˆé¹†);break;default:throw new Exception("http access type $¥é¹› not support");}return self::$¨ç¹Œ;}public static function makeQuery($¦å¸”,$Ñè¸—='&'){$Òæ½Œ='';while(list($Óè¼‚,$Ôè¸‡)=each($¦å¸”)){$Òæ½Œ.=($Òæ½Œ?"$Ñè¸—":"");$Òæ½Œ.=rawurlencode($Óè¼‚)."=".rawurlencode($Ôè¸‡);}return $Òæ½Œ;}}abstract class EmStatic_Http_Basic{static $¨ç¹Œ=NULL;protected $Õæ¾='';protected $Öä¾–=array();protected $×é»—='';protected $Øè¾Ÿ=array();protected function __clone(){}public function __construct($ˆé¹†){$this->uri=$ˆé¹†;}public function setHeader($Öä¾–){if(empty($Öä¾–)){return;}if(is_array($Öä¾–)){foreach($Öä¾– as $Óè¼‚=>$Ôè¸‡){$this->header[]=is_numeric($Óè¼‚)?trim($Ôè¸‡):(trim($Óè¼‚).": ".trim($Ôè¸‡));}}elseif(is_string($Öä¾–)){$this->header[]=$Öä¾–;}}public function setCookie($Ùé¼š){if(empty($Ùé¼š)){return;}if(is_array($Ùé¼š)){$this->cookies=Http::makeQuery($Ùé¼š,';');}elseif(is_string($Ùé¼š)){$this->cookies=$Ùé¼š;}}public function setVar($Øè¾Ÿ){if(empty($Øè¾Ÿ)){return;}if(is_array($Øè¾Ÿ)){$this->vars=$Øè¾Ÿ;}}public function setUrl($ˆé¹†){if($ˆé¹†!=''){$this->uri=$ˆé¹†;}}public function get($ˆé¹†='',$Øè¾Ÿ=array(),$Öä¾–=array(),$Ùé¼š='',$Úé¼Š=5){$this->setUrl($ˆé¹†);$this->setHeader($Öä¾–);$this->setCookie($Ùé¼š);$this->setVar($Øè¾Ÿ);return $this->send('GET',$Úé¼Š);}public function post($ˆé¹†='',$Øè¾Ÿ=array(),$Öä¾–=array(),$Ùé¼š='',$Úé¼Š=5,$Ûé¾€=array()){$this->setUrl($ˆé¹†);$this->setHeader($Öä¾–);$this->setCookie($Ùé¼š);$this->setVar($Øè¾Ÿ);return $this->send('POST',$Úé¼Š);}protected function unchunkHttp11($¦å¸”){$‚æ»‘=0;$Üå¼†='';while($‚æ»‘<strlen($¦å¸”)){$İé»‰=substr($¦å¸”,$‚æ»‘,strpos(substr($¦å¸”,$‚æ»‘),"\r\n")+2);$Şç½=hexdec(trim($İé»‰));$‚æ»‘+=strlen($İé»‰);$ßä¹Š=substr($¦å¸”,$‚æ»‘,$Şç½);$Üå¼†.=$ßä¹Š;$‚æ»‘+=strlen($ßä¹Š);}return $Üå¼†;}}class EmStatic_Http_Curl extends EmStatic_Http_Basic{public function send($àä¼›='GET',$Úé¼Š=5,$Ûé¾€=array()){if($this->uri==''){throw new Exception(__CLASS__.": Access url is empty");}$áé¾Ÿ=curl_init();curl_setopt($áé¾Ÿ,CURLOPT_HEADER,0);curl_setopt($áé¾Ÿ,CURLOPT_FOLLOWLOCATION,1);curl_setopt($áé¾Ÿ,CURLOPT_RETURNTRANSFER,1);curl_setopt($áé¾Ÿ,CURLOPT_TIMEOUT,$Úé¼Š);if(!empty($Ûé¾€)){curl_setopt_array($áé¾Ÿ,$Ûé¾€);}if($àä¼›=='GET'&&!empty($this->vars)){$”ç¾š=Http::makeQuery($this->vars);$âç»š=parse_url($this->uri);$Ñè¸—=isset($âç»š['query'])?'&':'?';$this->uri.=$Ñè¸—.$”ç¾š;}if($àä¼›=='POST'){curl_setopt($áé¾Ÿ,CURLOPT_POST,1);curl_setopt($áé¾Ÿ,CURLOPT_POSTFIELDS,$this->vars);}if(!empty($this->cookies)){curl_setopt($áé¾Ÿ,CURLOPT_COOKIE,$this->cookies);}if(empty($this->header)){$this->header=array('User-Agent: Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1; InfoPath.1)',);}curl_setopt($áé¾Ÿ,CURLOPT_HTTPHEADER,$this->header);curl_setopt($áé¾Ÿ,CURLOPT_URL,$this->uri);$¦å¸”=curl_exec($áé¾Ÿ);if($ãèºŒ=curl_error($áé¾Ÿ)){curl_close($áé¾Ÿ);throw new Exception(__CLASS__." error: ".$ãèºŒ);}curl_close($áé¾Ÿ);return $¦å¸”;}}class EmStatic_Http_Sock extends EmStatic_Http_Basic{public function send($àä¼›='GET',$Úé¼Š=5,$Ûé¾€=array()){if($this->uri==''){throw new Exception(__CLASS__.": Access url is empty");}if($àä¼›=='GET'&&!empty($this->vars)){$”ç¾š=Http::makeQuery($this->vars);$âç»š=parse_url($this->uri);$Ñè¸—=isset($âç»š['query'])&&($âç»š['query']!='')?'&':'?';$this->uri.=$Ñè¸—.$”ç¾š;}$¦å¸”='';if($àä¼›=='POST'&&!empty($this->vars)){$¦å¸”=Http::makeQuery($this->vars);$this->setHeader('Content-Type: application/x-www-form-urlencoded');$this->setHeader('Content-Length: '.strlen($¦å¸”));}$ˆé¹†=parse_url($this->uri);$äå¾ˆ=$ˆé¹†['host'];$ååº‹=isset($ˆé¹†['port'])&&($ˆé¹†['port']!='')?$ˆé¹†['port']:80;$Èä»=isset($ˆé¹†['path'])&&($ˆé¹†['path']!='')?$ˆé¹†['path']:'/';$Èä».=isset($ˆé¹†['query'])?"?".$ˆé¹†['query']:'';array_unshift($this->header,$àä¼›." ".$Èä»." HTTP/1.1");$this->setHeader('User-Agent: Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1; InfoPath.1)');if(!preg_match("/^[\d]{1,3}\.[\d]{1,3}\.[\d]{1,3}\.[\d]{1,3}$/",$äå¾ˆ)){$this->setHeader("Host: ".$äå¾ˆ);}if($this->cookies!=''){$this->setHeader("Cookie: ".$this->cookies);}$this->setHeader("Connection: keep-alive");$Öä¾–='';foreach($this->header as $æé½){$Öä¾–.=$æé½."\r\n";}$Öä¾–.="\r\n";if($àä¼›=='POST'&&$¦å¸”!=''){$Öä¾–.=$¦å¸”."\r\n";}$çé½=gethostbyname($äå¾ˆ);if(!($‚æ»‘=fsockopen($çé½,$ååº‹,$èç¹,$éè¸,$Úé¼Š))){throw new Exception(__CLASS__.": Can't connect $äå¾ˆ:$ååº‹, errno:$èç¹,message:$éè¸");}fputs($‚æ»‘,$Öä¾–);$êä¼ƒ=1024;$ëäºŒ=fgets($‚æ»‘,$êä¼ƒ);$ìéº—=preg_split("/\s/",trim($ëäºŒ));if(isset($ìéº—[1])&&in_array($ìéº—[1],array('301','302'))){while(!feof($‚æ»‘)){$ëäºŒ=fgets($‚æ»‘,$êä¼ƒ);$íè½œ=preg_split("/\s/",trim($ëäºŒ));if(ucfirst(trim($íè½œ[0]))=='Location:'&&$íè½œ[1]!=''){$this->header=array();return $this->get(trim($íè½œ[1]));}}}$îè¸œ='';while(!feof($‚æ»‘)){$îè¸œ.=fgets($‚æ»‘,1160);}$¦å¸”=substr($îè¸œ,(strpos($îè¸œ,"\r\n\r\n")+4));if(strpos(strtolower($îè¸œ),'transfer-encoding: chunked')!==FALSE){$¦å¸”=$this->unchunkHttp11($¦å¸”);}fclose($‚æ»‘);return $¦å¸”;}}class EmStatic_Http_Stream extends EmStatic_Http_Basic{public function send($àä¼›='GET',$Úé¼Š=5,$Ûé¾€=array()){if($this->uri==''){throw new Exception(__CLASS__.": Access url is empty");}$âç»š=parse_url($this->uri);$äå¾ˆ=$âç»š['host'];if($àä¼›=='GET'&&!empty($this->vars)){$”ç¾š=Http::makeQuery($this->vars);$Ñè¸—=isset($âç»š['query'])&&($âç»š['query']!='')?'&':'?';$this->uri.=$Ñè¸—.$”ç¾š;}$¦å¸”='';if($àä¼›=='POST'&&!empty($this->vars)){$¦å¸”=Http::makeQuery($this->vars);}$this->setHeader('User-Agent: Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1; InfoPath.1)');if(!preg_match("/^[\d]{1,3}\.[\d]{1,3}\.[\d]{1,3}\.[\d]{1,3}$/",$äå¾ˆ)){$this->setHeader("Host: ".$äå¾ˆ);}if($this->cookies!=''){$this->setHeader("Cookie: ".$this->cookies);}$this->setHeader("Connection: Close");$ïç»Œ=array('http'=>array('method'=>$àä¼›,'timeout'=>$Úé¼Š,));if($¦å¸”!=''){$ïç»Œ['http']['content']=$¦å¸”;}$ïç»Œ['http']['header']='';foreach($this->header as $æé½){$ïç»Œ['http']['header'].=$æé½."\r\n";}if(!empty($Ûé¾€)){isset($Ûé¾€['proxy'])?$ïç»Œ['http']['proxy']=$Ûé¾€['proxy']:'';isset($Ûé¾€['max_redirects'])?$ïç»Œ['http']['max_redirects']=$Ûé¾€['max_redirects']:'';isset($Ûé¾€['request_fulluri'])?$ïç»Œ['http']['request_fulluri']=$Ûé¾€['request_fulluri']:'';}$ğå¸€=stream_context_create($ïç»Œ);if(($ñé»’=file_get_contents($this->uri,null,$ğå¸€))===false){throw new Exception(__CLASS__.": file_get_contents(".$this->uri.") fail");}return $ñé»’;}}class EMStatic_Pinyin{protected $òåº=array();private static $¨ç¹Œ;private function __construct(){$‚æ»‘=fopen(EM_STATIC_ROOT.'/res/pinyin.dat','r');while(!feof($‚æ»‘)){$ëäºŒ=trim(fgets($‚æ»‘));$this->_index[$ëäºŒ[0].$ëäºŒ[1]]=substr($ëäºŒ,3,strlen($ëäºŒ)-3);}fclose($‚æ»‘);}public function __destruct(){unset($this->_index);}public static function get_instance(){if(!self::$¨ç¹Œ){self::$¨ç¹Œ=new EMStatic_Pinyin();}return self::$¨ç¹Œ;}public function cover($óç¹ˆ,$ôç¹™=0){if(function_exists('iconv')){$óç¹ˆ=iconv('utf-8','GBK',$óç¹ˆ);}else if(function_exists('mb_convert_encoding')){$óç¹ˆ=mb_convert_encoding($óç¹ˆ,'GBK','utf-8');}$õæ¾‚='';$óç¹ˆ=trim($óç¹ˆ);$öé¹ =strlen($óç¹ˆ);if($öé¹ <2){return $óç¹ˆ;}for($³å¾ˆ=0;$³å¾ˆ<$öé¹ ;$³å¾ˆ++){if(ord($óç¹ˆ[$³å¾ˆ])>0x80){$÷å¼Š=$óç¹ˆ[$³å¾ˆ].$óç¹ˆ[$³å¾ˆ+1];$³å¾ˆ++;if(isset($this->_index[$÷å¼Š])){if($ôç¹™==0){$õæ¾‚.=$this->_index[$÷å¼Š];}else{$õæ¾‚.=$this->_index[$÷å¼Š][0];}}else{$õæ¾‚.="_";}}else if(preg_match("/[A-Za-z0-9]/",$óç¹ˆ[$³å¾ˆ])){$õæ¾‚.=$óç¹ˆ[$³å¾ˆ];}else{$õæ¾‚.="_";}}return $õæ¾‚;}}